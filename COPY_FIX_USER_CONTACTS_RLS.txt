-- Copy everything below this line and paste into Supabase SQL Editor
-- URL: https://app.supabase.com/project/btyjxckmqzqdqurgoojd/editor/sql
-- This fixes the RLS policies for user_contacts table

-- Drop existing policies
DROP POLICY IF EXISTS "Allow authenticated users to read their own user_contact" ON public.user_contacts;
DROP POLICY IF EXISTS "Allow authenticated users to insert their own user_contact" ON public.user_contacts;
DROP POLICY IF EXISTS "Allow authenticated users to update their own user_contact" ON public.user_contacts;
DROP POLICY IF EXISTS "Allow authenticated users to delete their own user_contact" ON public.user_contacts;
DROP POLICY IF EXISTS "Allow public read access to user_contacts" ON public.user_contacts;

-- Policy: Allow authenticated users to read their own contact info
CREATE POLICY "Allow authenticated users to read their own user_contact"
ON public.user_contacts
FOR SELECT
TO authenticated
USING (
  user_code = REPLACE(auth.uid()::text, '-', '')
);

-- Policy: Allow public read access (for viewing profiles)
CREATE POLICY "Allow public read access to user_contacts"
ON public.user_contacts
FOR SELECT
TO anon, authenticated
USING (true);

-- Policy: Allow authenticated users to insert their own contact info
CREATE POLICY "Allow authenticated users to insert their own user_contact"
ON public.user_contacts
FOR INSERT
TO authenticated
WITH CHECK (
  user_code = REPLACE(auth.uid()::text, '-', '')
);

-- Policy: Allow authenticated users to update their own contact info
CREATE POLICY "Allow authenticated users to update their own user_contact"
ON public.user_contacts
FOR UPDATE
TO authenticated
USING (
  user_code = REPLACE(auth.uid()::text, '-', '')
)
WITH CHECK (
  user_code = REPLACE(auth.uid()::text, '-', '')
);

-- Policy: Allow authenticated users to delete their own contact info
CREATE POLICY "Allow authenticated users to delete their own user_contact"
ON public.user_contacts
FOR DELETE
TO authenticated
USING (
  user_code = REPLACE(auth.uid()::text, '-', '')
);

-- Success message
DO $$
BEGIN
  RAISE NOTICE 'user_contacts RLS policies fixed successfully!';
END $$;

